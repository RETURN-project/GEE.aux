---
title: "Calculate recovery metrics"
author: "Wanda De Keersmaecker"
date: "1/7/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(zoo)
```

## inputs
```{r inputs}
# path to folder with data
ifolder <- '/inst/testdata/'
# path to folder where outputs should be stored
ofolder <- '/inst/testdata/'
# name of data files
ifiles <- c('test2.csv')
```

```{r tidy_data}
for (file in ifiles){
  ifile <- file.path(ifolder,file)
  x <- readLines(ifile)
  col_names <- c("id","ecoReg","lossyr","coords","img_names","series")
  dat_tidy <- tidy_data(x,col_names)
  write_csv(dat_tidy, file.path(ofolder, paste0('tidy_',file)))
}
```

```{r regular_ts}

# ifolder <- '/home/wanda/Documents/data/upscaleRecovery/test'
# ifile <- 'tidy_test2.csv'



# dat <- read_csv(file.path(ifolder,ifile))

cols <- names(dat_tidy)
dtcols <- cols[startsWith(cols,"p__")]
obscols <- cols[startsWith(cols,"series__")]
auxcols <- cols[!startsWith(cols,"p__") & !startsWith(cols,"series__")]

mnyr <- format(as.Date(as.character(min(dat_tidy[,dtcols], na.rm = T)),'%Y%m%d'),'%Y')
mxyr <- format(as.Date(as.character(max(dat_tidy[,dtcols], na.rm = T)),'%Y%m%d'),'%Y')

startdt <- as.Date(paste0(mnyr,'-01-01'))
enddt <- as.Date(paste0(mxyr,'-12-31'))
dts <- seq(startdt,enddt,by='month')

dtsi <- dat_tidy[,dtcols]
dtsi <- cbind(rep(as.numeric(paste0(mnyr,'0101')),dim(dtsi)[1]),rep(as.numeric(paste0(mxyr,'1231'),dim(dtsi)[1])),dtsi)
obsi <- dat[,obscols]
obsi <- cbind(rep(NA,dim(obsi)[1]),rep(NA,dim(obsi)[1]),obsi)

test <- function(dts,obs){
  obs <- obs[!is.na(dts)]
  dts <- dts[!is.na(dts)]
  dts <- as.Date(as.character(dts),'%Y%m%d')
  regts <- toRegularTS(obs, dts, 'mean', 'monthly')
} 

out <- sapply(1:dim(obsi)[1], function(i) test(dtsi[i,], obsi[i,]))
df_out <- as.data.frame(t(out))
names(df_out) <- dts
df_out <- cbind(dat_tidy[,auxcols],df_out)
save(df_out, file = file.path(ifolder, 'reg_test2.Rdata'))

```

```{r segment}
library(bfast)
library(strucchange)

# ifolder <- '/home/wanda/Documents/data/upscaleRecovery/test'
# ifile <- 'reg_test2.Rdata'

# load(file.path(ifolder, ifile))
nts <- dim(df_out)[1]
  
seg <- lapply(1:nts, function(i){getSegments(as.numeric(df_out[i,-c(1:5)]),12,0.15,T)})
save(seg, file = file.path(ifolder, 'seg_test2.Rdata'))

```

```{recovery}
# ifolder <- '/home/wanda/Documents/data/upscaleRecovery/test'

# load(file.path(ifolder, 'reg_test2.Rdata'))
# load(file.path(ifolder, 'seg_test2.Rdata'))

# dts <- as.Date(names(df_out)[-c(1:5)])

obspyr <- 12
nPre <- 2
nDist <- 1
nPost <- 2
nPostStart <- 4
nDelta <- 2
nDeltaStart <- 4
maxBreak <- F
chkBrk <- T
timeThres <- 1.5

tst <- lapply(1:50,function(i){
  dtdist <- as.Date(paste0(as.character(2000+df_out$lossyr[i]),'-06-01'))
  tdist <- which(dts == dtdist)
  tsi <- seg[[i]]$trend
  tbp <- seg[[i]]$breakpoints
  tbp <- tbp[tbp!=0 & tbp!=length(tsi)]
  calcRecMetrics(tsi, tdist, obspyr, nPre, nDist, nPost, nPostStart, nDelta, nDeltaStart,
                                                  tbp, maxBreak, chkBrk,timeThres)})

df_fr <- data.frame(do.call(rbind.data.frame, tst))
df_rec <- cbind(df_out[c(1:50),c(1:5)], df_fr)

save(df_rec, file = file.path(ifolder, 'rec_test2.Rdata'))
```

```{plot}

```

```{r inputs}
# library(tidyverse)
# # setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
# input_folder <- "/home/wanda/Documents/data/upscaleRecovery/test"
# output_folder <- "/home/wanda/Documents/data/upscaleRecovery/test"
# file_list <- "test2.csv"#list.files(path=input_folder,pattern="test2.csv")
# 
# 
# for (file in file_list){
#   a <- str_split(tools::file_path_sans_ext(file),"_")%>%unlist
#   tmpf <- tempfile()
#   x <- readLines(file.path(input_folder,file))
#   y <-  substr(x,2,str_length(x)-1)  
#   z <- gsub( "]", "[", y )
#   z <- z[-1]
#   cat(z, file=tmpf, sep="\n")
#   col_names <- c("id","ecoReg","lossyr","coords","img_names","series")
#   # 
#   dat_orig <- read_csv(tmpf, quote="[",
#                         col_names=col_names)
#   # count number of images per series
#   dat_format <- dat_orig%>%
#     mutate(nimg=str_count(img_names,",")+1)
# 
#   extract_date <- function(x){
#     # stl <- str_count(x)
#     # substr(x,20,27)
#     sp <- strsplit(x,'_')
#     L <- lapply(sp, function(x) {
#       if(length(x) > 1){x[length(x)-1]
#         } else{x[1]}} )
#     # sp[[1]][]
#     unlist(L)
#   }
#   
#   
#   
#   # x <- dat_format$img_names[18]
#   
#   max_img <- max(dat_format$nimg)
#   nvars_img=sprintf("p__%04i",seq(from=1,to=max_img))
#   nvars_1=sprintf("series__%04i",seq(from=1,to=max_img))
#   
#   dat_format_img <- dat_format%>%
#     separate(img_names,into=nvars_img,sep=", ",convert=TRUE)%>%
#     separate(series,into=nvars_1,sep=", ",convert=TRUE)%>%
#     mutate_at(vars(starts_with("p__")),extract_date)%>%
#     mutate_all(~str_replace(.,"None","NA"))
#   
#   write_csv(dat_format_img, file.path(output_folder,paste0('tidy_',file)))
#   
# }
# 
# ## 

```

